#!/bin/bash

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ–ø–æ–º–æ–≥–∏
show_help() {
#     echo "–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: $0 [–æ–ø—Ü—ñ—ó]"
    echo "üìñ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: $0 [–æ–ø—Ü—ñ—ó]"
    echo "–û–ø—Ü—ñ—ó:"
    echo "  --apt       –û–Ω–æ–≤–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é apt"
    echo "  --flatpak   –û–Ω–æ–≤–∏—Ç–∏ –¥–æ–¥–∞—Ç–∫–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é flatpak"
    echo "  --snap      –û–Ω–æ–≤–∏—Ç–∏ –¥–æ–¥–∞—Ç–∫–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é snap"
    echo "  --shutdown  –û–Ω–æ–≤–∏—Ç–∏ —Ç–∞ –≤–∏–º–∫–Ω—É—Ç–∏ —Å–∏—Å—Ç–µ–º—É"
    echo "  --reboot    –û–Ω–æ–≤–∏—Ç–∏ —Ç–∞ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É"
    echo "  --help      –í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ —Ü—é –¥–æ–ø–æ–º–æ–≥—É"
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º apt
update_apt() {
#     echo "–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –ø–∞–∫–µ—Ç—ñ–≤..."
    echo "üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –ø–∞–∫–µ—Ç—ñ–≤..."
    echo "$PASSWORD" | sudo -S apt update

#     echo "–û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—Ö –ø–∞–∫–µ—Ç—ñ–≤..."
    echo "‚¨ÜÔ∏è  –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—Ö –ø–∞–∫–µ—Ç—ñ–≤..."
    echo "$PASSWORD" | sudo -S apt upgrade -y

#     echo "–û—á–∏—â–µ–Ω–Ω—è –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω–∏—Ö –ø–∞–∫–µ—Ç—ñ–≤..."
    echo "üßπ –û—á–∏—â–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏..."
    echo "$PASSWORD" | sudo -S apt autoremove -y
    echo "$PASSWORD" | sudo -S apt clean
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—ñ–≤ –∑ Flathub
update_flatpak() {
#     echo "–û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—ñ–≤ Flatpak..."
    echo "üì¶ –û–Ω–æ–≤–ª–µ–Ω–Ω—è Flatpak-–¥–æ–¥–∞—Ç–∫—ñ–≤..."
    flatpak update -y
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—ñ–≤ –∑ Snap
update_snap() {
#     echo "–û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—ñ–≤ Snap..."
    echo "üì¶ –û–Ω–æ–≤–ª–µ–Ω–Ω—è Snap-–¥–æ–¥–∞—Ç–∫—ñ–≤..."
    echo "$PASSWORD" | sudo -S snap refresh
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–º–∫–Ω–µ–Ω–Ω—è –∞–±–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏
manage_system() {
    if [ "$1" == "--shutdown" ]; then
#         echo "–í–∏–º–∫–Ω–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏..."
        echo "‚èª –í–∏–º–∫–Ω–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏..."
        echo "$PASSWORD" | sudo -S shutdown -h now
    elif [ "$1" == "--reboot" ]; then
#         echo "–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏..."
        echo "üîÅ –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏..."
        echo "$PASSWORD" | sudo -S reboot
    fi
}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞
if [ "$1" == "--help" ]; then
    show_help
    exit 0
fi

# –ó–∞–ø–∏—Ç –ø–∞—Ä–æ–ª—é
for i in {1..3}; do
#     read -sp "–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è sudo: " PASSWORD
    read -sp "üîê –í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: " PASSWORD
    echo

    echo "$PASSWORD" | sudo -S -v 2>/dev/null
    if [ $? -eq 0 ]; then
        break
    else
#         echo "–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å. –°–ø—Ä–æ–±–∞ $i —ñ–∑ 3."
        echo "‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å. –°–ø—Ä–æ–±–∞ $i –∑ 3."
    fi

    if [ $i -eq 3 ]; then
#         echo "–ó–∞–±–∞–≥–∞—Ç–æ –Ω–µ–≤–¥–∞–ª–∏—Ö —Å–ø—Ä–æ–±. –í–∏—Ö—ñ–¥."
        echo "üö´ –ó–∞–±–∞–≥–∞—Ç–æ –Ω–µ–≤–¥–∞–ª–∏—Ö —Å–ø—Ä–æ–±. –í–∏—Ö—ñ–¥ –∑ –ø—Ä–æ–≥—Ä–∞–º–∏."
        exit 1
    fi
done

update_all=true
for arg in "$@"; do
    case $arg in
        --apt)
            update_apt
            update_all=false
            ;;
        --flatpak)
            update_flatpak
            update_all=false
            ;;
        --snap)
            update_snap
            update_all=false
            ;;
        --shutdown)
            shutdown=true
            ;;
        --reboot)
            reboot=true
            ;;
    esac
done

# –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –æ–Ω–æ–≤–ª—é—î–º–æ apt, flatpak —ñ snap, —è–∫—â–æ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ —ñ–Ω—à–µ
if $update_all; then
    update_apt
    echo ""
    update_snap
    echo ""
    update_flatpak
    echo ""
fi

# –í–∏–º–∫–Ω–µ–Ω–Ω—è –∞–±–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏
if [ "$shutdown" == true ]; then
    manage_system "--shutdown"
elif [ "$reboot" == true ]; then
    manage_system "--reboot"
fi

# echo "–û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "‚úÖ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
